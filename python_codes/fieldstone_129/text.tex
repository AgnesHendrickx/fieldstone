\begin{flushright} {\tiny {\color{gray} python\_codes/fieldstone\_129/text.tex}} \end{flushright}

\lstinputlisting[language=bash,basicstyle=\small]{python_codes/fieldstone_129/keywords}

\begin{center}
\fbox{\textbf{\huge \color{teal} P}}
Codes at \url{https://github.com/cedrict/fieldstone/tree/master/python_codes/fieldstone_129}
\end{center}

\par\noindent\rule{\textwidth}{0.4pt}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Following chapter 12 of Guy Simpson's book \cite{simp17} 
we have\footnote{I have slightly changed the notations.}

\[
\left(
\begin{array}{c}
\sigma_{xx}\\ 
\sigma_{yy}\\ 
\sigma_{xy} 
\end{array}
\right)
=
\left(
\begin{array}{ccc}
\frac{\delta t(4\mu \eta + 3K \eta+ 3K \mu\delta t)}{3(\mu \delta t + \eta)} &
\frac{\delta t(3K \eta+ 3K \mu\delta t - 2\mu \eta)}{3(\mu \delta t + \eta)} &
0 \\
\frac{\delta t(3K \eta+ 3K \mu\delta t  - 2\mu \eta)}{3(\mu \delta t + \eta)}&
\frac{\delta t(4\mu \eta + 3K \eta+ 3K \mu\delta t)}{3(\mu \delta t + \eta)} &
0  \\
0 & 0 & \frac{\mu \eta \delta t }{\mu \delta t + \eta}  \\
\end{array}
\right)
\cdot
\left(
\begin{array}{c}
\dot\varepsilon_{xx}\\ 
\dot\varepsilon_{yy}\\ 
{\color{teal}2}\dot\varepsilon_{xy} 
\end{array}
\right) 
+
\left(
\begin{array}{cccccc}
\frac13\frac{3\eta + \mu \delta t}{\mu\delta t+\eta} & 
\frac13\frac{\mu \delta t}{\mu\delta t+\eta} & 
0\\
\frac13\frac{\mu \delta t}{\mu\delta t+\eta} & 
\frac13\frac{3\eta + \mu \delta t}{\mu\delta t+\eta} & 
0\\
0 & 0 & \frac{ \eta}{\mu\delta t + \eta}  
\end{array}
\right)
\cdot
\left(
\begin{array}{c}
\sigma_{xx}^0\\ 
\sigma_{yy}^0\\ 
\sigma_{xy}^0 
\end{array}
\right) 
\]
or, 
\[
\vec{\sigma} = \tilde{\bm D}\cdot \vec{\dot{\varepsilon}} +
{\bm D}_s \cdot \vec{\sigma}_0 
\]
Note the green '2' in the equation above: in Simpson's book it is in the
lower right term of the matrix. Also, Simpson uses $\mu$ for the viscosity
while we here use $\eta$. 

We see that pressure is not a degree of freedom so the finite element
formulation and discretisation will not yield a saddle point problem, 
which is a good thing in terms of complexity and solving procedure.

In the end the following weak form is obtained:
\[
\int {\bm B}^T \cdot \tilde{\bm D} \cdot {\bm B} dV \cdot \vec{\cal V} 
= \int \vec{\bN} \rho \vec{g} dV -\int {\bm B}^T \cdot {\bm D}_s \cdot \vec{\sigma}_0 dV
\]

We need to keep track of the stress $\vec{\sigma}_0$ and 
we do so directly at the quadrature points.
The strain rate vector is recomputed at every time step but it is also 
directly stored on the quadrature points.

The current stress vector $\vec{\sigma}$ is also on the quadrature points and
is computed by means of the equation above.

In the end we declare the following arrays:
\begin{lstlisting}
nqperdim=3
nq=nel*nqperdim**ndim # total number of quadrature points
stress0_vector    = np.zeros((3,nq),dtype=np.float64) # stress vector memory
stress_vector     = np.zeros((3,nq),dtype=np.float64) # stress vector 
strainrate_vector = np.zeros((3,nq),dtype=np.float64) # strain rate vector
\end{lstlisting}

The code relies on quadratic elements ($Q_2$).
Each element is assigned a 'phase' (a material) and 
each material can have different values of $\mu, \eta, \nu, K, E$.

As is common when modelling elasto-viscous materials
we define an effective viscosity:
\[
\eta_{eff} 
= \frac{\eta \delta t}{\delta t + \eta/\mu} 
\]

The 'stress memory' rhs is computed as follows:
\begin{lstlisting}
f_el-=b_mat.T.dot(stress_vector[:,counterq])*weightq*jcob
\end{lstlisting}



The mesh deforms with the material flow (Lagrangian approach)
and this is simply implemented as follows 

\begin{lstlisting}
xV[:]+=u[:]*dt
yV[:]+=v[:]*dt
\end{lstlisting}

The mean stress can also be computed and visualised:
\[
\sigma_m 
= \frac{1}{3}(\sigma_{xx}+\sigma_{yy}+\sigma_{zz})
= \frac{1}{3}(\sigma_{xx}+\sigma_{yy}+\frac12(\sigma_{xx}+\sigma_{yy}))
= \frac{1}{2}(\sigma_{xx}+\sigma_{yy})
\]

The matrix $\tilde{\bm D}$ is implemented as follows:

\begin{lstlisting}
di=dt*(3*eta[iel]*K[iel]+3*dt*mu[iel]*K[iel]+4*mu[iel]*eta[iel])
od=dt*(-2*mu[iel]*eta[iel]+3*eta[iel]*K[iel]+3*dt*mu[iel]*K[iel])
d=3*(eta[iel]+dt*mu[iel])
ed=eta[iel]*dt*mu[iel]/(eta[iel]+dt*mu[iel])
Dee = np.array([[di/d, od/d,  0],\
                [od/d, di/d,  0],\
                [0,       0, ed]],dtype=np.float64)
\end{lstlisting}
while the matrix ${\bm D}_s$ is implemented as follows
\begin{lstlisting}
di=3*eta[iel]+dt*mu[iel]
od=dt*mu[iel] 
ed=eta[iel]/(eta[iel]+dt*mu[iel]) 
Dees = np.array([[di/d, od/d,  0],\
                 [od/d, di/d,  0],\
                 [0,       0, ed]],dtype=np.float64)
\end{lstlisting}

In the case of a power-law viscous rheology, we have $\dot{\varepsilon}=A \tau^n$.
If we now write $\tau=2 \eta_{eff} \dot\varepsilon$, or
\[
\eta_{eff} = \frac12 \frac{\tau}{\dot\varepsilon} = \frac12 \frac{\tau}{A \tau^n} = \frac12 A^{-1} \tau^{1-n}
\]


\newpage
%------------------------------------------------------------------------------
\subsection*{Folding (experiment=1)}

Boundary conditions are free slip on the left, right and bottom boundaries, while
a horizontal velocity of $\SI{5}{\mm\per\year}$ is prescribed on the right 
boundary\footnote{The vertical component of the velocity 
on the right wall is not clear, but looking at the figure we see that 
the thickening is the same on the left and right, so that the
vertical velocity on the right is unconstrained.}.

In the book, the time step is fixed to 
\[
\delta t = 0.01/edot = 0.01*Lx/u_{bc} = 0.01*4/5e-3 = \SI{0.8}{\year}
\]

\begin{center}
\includegraphics[width=13cm]{python_codes/fieldstone_129/images/simpson1}\\
{\captionfont  
Numbers indicate the lithological unit (termed the ``phase'' in the Matlab script). 
The folding experiment was
performed with a viscoelastic material where the central layer (i.e., phases 3 and 4) 
has a shear viscosity ($\eta=\SI{1e20}{\pascal\second}$) that
is 100 times greater than that of the surrounding matrix ($\SI{1e18}{\pascal\second}$). 
Other parameters are as follows: 
density = $\SI{2700}{\kg\per\cubic\meter}$ , 
gravity = $\SI{9.8}{\meter\per\square\second}$, 
Young's modulus = $\SI{1e11}{\pascal}$, 
Poissonâ€™s ratio = 0.3 (all considered uniform throughout),
and a 40x40 elements.}
\end{center}

The position of the nodes on the interface between the layer and the matrix is 
perturbed with a random signal:
\begin{lstlisting}
for i in range(0,NV):
    if abs(yV[i]-0.45)/Ly<eps:
       yV[i]+=hy*0.05*random.uniform(-1,1)
    if abs(yV[i]-0.55)/Ly<eps:
       yV[i]+=hy*0.05*random.uniform(-1,1)
\end{lstlisting}


\begin{center}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment1/phase}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment1/eta}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment1/etaeff}\\
{\captionfont Initial setup of the experiment.}
\end{center} 

\begin{verbatim}
viscosity eta    = [1.e+18 1.e+18 1.e+20]
Young modulus E  = [1.e+11 1.e+11 1.e+11]
shear modulus mu = [3.84615385e+10 3.84615385e+10 3.84615385e+10]
bulk modulus K   = [8.33333333e+10 8.33333333e+10 8.33333333e+10]
poisson ratio nu = [0.3 0.3 0.3]
\end{verbatim}


\begin{center}
\includegraphics[width=10cm]{python_codes/fieldstone_129/images/simpson2}\\
{\captionfont 
Folding in a layered viscoelastic material after 40\% shortening. The central 
layer has a viscosity 100 higher than the surrounding matrix. The shaded colors 
represent mean stress, while the grid shows finite deformation 
(which is not the computational mesh). Unfortunately no color legend.}
\end{center}

what about pre-stress, initial compaction?

Remark:
- p191, viscosity values in 1) are wrong ? different?



\begin{center}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment1/stats_velocity}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment1/stats_strainrate}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment1/stats_stress}\\
{\captionfont a}
\end{center} 


\begin{center}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/eta0000}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/eta0099}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/eta0199}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/eta0299}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/eta0399}\\
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/vel0000}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/vel0099}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/vel0199}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/vel0299}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/vel0399}\\
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/sigmam0000}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/sigmam0099}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/sigmam0199}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/sigmam0299}
\includegraphics[width=3.4cm]{python_codes/fieldstone_129/results/experiment1/sigmam0399}\\
\end{center}

{\color{red} this experiment works fine, elastic properties constant in space,
only viscous props vary}


%------------------------------------------------------------------------------
\subsection*{Analytical benchmark - pure shear (experiment=2)}

The domain is $\SI{50}{\km}\times\SI{50}{\km}$. There is a single 
material in the domain characterised by $\eta=\SI{1e21}{\pascal\second}$,
$\mu=\SI{1e10}{\pascal}$. The time step is $\delta t=100~\si{\year}$.
Boundary conditions are free slip on all sides, with $u=+\SI{1}{\cm\per\year}$
on the right and $v=-\SI{1}{\cm\per\year}$ on the top.

The unstressed, {\it incompressible} viscoelastic Maxwell medium is subjected to a velocity field 
resulting in pure shear. 
The increase of the accumulated stress with time is given by an analytical solution:
\begin{equation}
{\bm \tau} 
= 2\eta\ {\dot{\bm \varepsilon}} \left ( 1-\exp\left(-\frac{\mu }{\eta} t \right) \right )
= 2\eta\ {\dot{\bm \varepsilon}} \left ( 1-\exp\left(-\frac{t}{t_M} \right) \right )
\end{equation}
where the Maxwell time is $t_M = \frac{\eta}{\mu} = \SI{1e11}{\second} \simeq 3171~\si{\year}$.

\begin{center}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment2/vel}\\
{\captionfont Velocity field.}
\end{center}

We have 
\[
\eta_{eff} 
= \frac{\eta \delta t}{\delta t + \eta/\mu} 
= \frac{10^{21} \cdot 3.154\times 10^{9}}{3.154\times 10^{9} + 10^{21}/10^{10}} 
\simeq 
\SI{3.0592e19}{\pascal\second} 
\]

The resolution is set to $10\times 10$ elements. 200 time steps are carried out.

\begin{center}
\includegraphics[width=8cm]{python_codes/fieldstone_129/results/experiment2/stats_stress}\\
{\captionfont Evolution or $\sigma_{xx}$ statistics over 20~kyr for various values of $\nu$.}
\end{center} 



%------------------------------------------------------------------------------
\subsection*{Numerical benchmark - Bending of elastic slab (experiment=3)}

This benchmark is a numerical benchmark, but not an analytical one. 
It originates in Taras Gerya's book. It is originally for incompressible visco-elastic fluids so we will run it at different values of the Poisson ratio parameter.
It is also carried out in \stone~64.

The sinking slab benchmark consists of a beam of elastic material which is placed 
in a weak and viscous surrounding medium. The initially unstressed beam is attached 
to the left domain boundary through boundary conditions. A stress is then applied to  
the beam in the form of gravity. The applied gravity force results in the deformation 
of the beam through bending. After 20 kyr, the gravity field is turned off and the 
elastic properties of the beam will then force itself to its original position.  
The set-up of the benchmark is given in the following figure: 

\begin{center}
\includegraphics[width=6cm]{python_codes/fieldstone_64/images/poster_benchmark.png}\\
\captionfont{Set-up of the benchmark from \cite{gery10}. The properties of the 
two materials are given on the left, together\\ with the initial configuration of the benchmark.} 
\end{center}

The 800x600km beam is surrounded by a low-density, low-viscosity and high shear modulus medium 
of which the specifications are given in  the following table.
The boundary conditions of the domain consist of a no slip condition at  
the left boundary where the slab is attached and free slip boundary conditions along all other sides. 
The results are calculated on a grid with a resolution of 50x50 elements.
The time step is set to $\delta t = 200yr$ (i.e. gravity is switched off after 100 time steps).

As explained in the book: ``
The slab deformation is purely elastic due to the large Maxwell time (3 170 000 kyr) of slab material
compared to the total deformation time (20 000 kyr). In contrast, the low viscosity medium
is subjected to irreversible, purely viscous deformation since its Maxwell time (\num{3.17e-10} kyr) 
is negligible compared to the deformation time.''

\begin{center}
\begin{tabular}{lll}
\hline 
\textit{Material properties}& \textit{Elastic slab (fluid 1)}  & \textit{Surrounding medium (fluid 2)} \\
\hline 
\hline
Density         $\rho$ \  [kg/m$^{3}$]            & 4000                    & 1     \\
Viscosity       $\eta$ \  [\si{\pascal\second}]    & $10^{27}$               &   $10^{21}$     \\
Shear modulus   $\mu $ \  [\si{\pascal}]           & $10^{10}$               & $10^{20}$       \\
Maxwell time $t_M$     \  [yr]                     & 3.17Gyr                 &  $3.17\times10^{-7}$yr       \\
eff. visc.      $\eta_{eff}$ \ [\si{\pascal\second}] & 6.307199602192306e+19   &  9.999999984145105e+20      \\
\hline
\end{tabular}
\end{center}


\begin{center}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment3/phase}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment3/eta}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment3/etaeff}\\
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment3/rho}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment3/mu}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment3/K}\\
{\captionfont Initial setup of the experiment.}
\end{center} 

{\color{red} this happily explodes no matter the poisson ratio value!}
It kinda looks like things go mostly wrong in the purely viscous part?



\newpage
%------------------------------------------------------------------------------
\subsection*{Numerical benchmark - Flexure of elastic plate (experiment=4)}

This benchmark is presented in \textcite{chtl13}. 

\begin{center}
\includegraphics[width=8cm]{python_codes/fieldstone_129/images/chtl13a}
\includegraphics[width=8cm]{python_codes/fieldstone_129/images/chtl13b}\\
{\captionfont 
Taken from \textcite{chtl13}. ``Effect of elastic compressibility on the prediction 
of an elastic thin plate subject to an uplifting load. (a)
Model setup for a finite length elastic layer subjected to a
finite length buoyant load applied on the bottom. (b) Profiles
of mean-subtracted surface topography.''}
\end{center}


\begin{center}
\begin{tabular}{llll}
\hline 
\textit{Material properties}& \textit{elastic plate (1)}  & \textit{elastic block (2)} & \textit{viscous mantle (3)} \\
\hline 
\hline 
Density         $\rho$       \ \si{\kg\per\cubic\meter} & 2700&1890 &2700 \\  
Viscosity       $\eta$       \ \si{\pascal\second}      & $10^{35}$& $10^{35}$ & $10^{17}$ \\  
Shear modulus   $\mu $       \ \si{\pascal}             & $30\cdot10^9$& $30\cdot10^9$&  $10^{50}$ \\
Maxwell time    $t_M$        \ \si{\year}               & 10569930 &  10569930 & 3.1709791983764584e-41 \\  
eff. visc.      $\eta_{eff}$ \ \si{\pascal\second}      & 4.73039776e+18& 4.73039776e+18&  1e+17\\ 
\hline 
\end{tabular} 
\end{center}

\begin{center}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment4/phase}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment4/etaeff}
\includegraphics[width=5.7cm]{python_codes/fieldstone_129/results/experiment4/rho}\\
{\captionfont Initial setup of the experiment.}
\end{center} 


{\color{red}This explodes when shear modulus contrast becomes too big, i.e. when a material 
essentially becomes purely viscous by having its $\mu$ very large. }
It showcases oscillations at the beginning too!





\newpage
%------------------------------------------------------------------------------
\subsection*{Numerical benchmark - Parallel-plate viscosimeter (experiment=5)}

\begin{center}
\includegraphics[width=6cm]{python_codes/fieldstone_129/results/experiment5/setup}
\end{center}


